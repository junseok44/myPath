{% extends 'base.html' %} {% load static %} {% block content %}
<div class="writePage">
  <h1>제작 페이지</h1>
  <form onsubmit="handleSubmit(event)">
    <div class="writePage__intro">
      <p class="writePage__titleBox">
        <label class="labelfor">제목</label>
        <input
          class="write__input"
          type="text"
          placeholder="포스트 제목"
          name="title"
          id="titleInput"
          required="required"
        />
      </p>
      <div class="writePage__meta">
        <label class="labelfor">카테고리</label>
        <select id="categorySelect" name="categorySelect">
          {% for cat in categories %}
          <option value="{{cat.name}}">{{cat.name}}</option>
          {% endfor %}
        </select>

        <label class="labelfor">태그</label>
        <input
          type="text"
          id="tagInput"
          placeholder="태그를 입력후 enter버튼을 눌러 추가하세요"
        />
      </div>
      <ul id="tagList"></ul>

      <div class="writePage__thumbnail">
        <span class="labelfor">썸네일</span>
        <input type="file" id="imageInput" />
      </div>
    </div>
    <div class="writePage__desc">
      <textarea
        type="text"
        placeholder="포스트 설명"
        name="dsec"
        id="descInput"
        required="required"
      ></textarea>
    </div>
    <div class="writePage__controlBox">
      <div class="pathSelect">
        <span>패스 선택</span>
        <select id="pathSelect" class="select"></select>
      </div>
      <button
        type="button"
        onclick="toggleMode()"
        class="btn mode-btn writePage__btn"
      >
        세로모드로
      </button>
    </div>
    <hr />

    <ul class="main main-container column-mode writePage__main">
      <button
        type="button"
        onclick="handleAddPath()"
        class="btn add_new-btn writePage__btn"
      >
        패스 추가하기
      </button>
    </ul>
    <hr />

    <div class="writePage__review">
      <textarea
        type="text"
        name="review"
        placeholder="후기"
        id="reviewInput"
      ></textarea>
    </div>

    <button type="submit" class="btn writePage__btn">글 등록하기</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>

<!-- csrf token -->
<script src="{% static 'post/writePage/csrftoken.js' %}"></script>

<!-- 태그기능 -->
<script>
  // JavaScript code
  const tagList = []; // Array to store tags

  function addTag(tag) {
    if (!tagList.includes(tag)) {
      tagList.push(tag);
      updateTagList();
    }
  }

  function removeTag(tag) {
    const index = tagList.indexOf(tag);
    if (index !== -1) {
      tagList.splice(index, 1);
      updateTagList();
    }
  }

  function updateTagList() {
    const tagListElement = document.getElementById("tagList");
    tagListElement.innerHTML = ""; // Clear the current list

    tagList.forEach((tag) => {
      const li = document.createElement("li");
      const closeButton = document.createElement("span");
      closeButton.innerText = "x";
      closeButton.classList.add("close-button");
      closeButton.onclick = () => removeTag(tag);

      li.innerText = "#" + tag;
      li.appendChild(closeButton);

      tagListElement.appendChild(li);
    });
  }

  document.getElementById("tagInput").addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault(); // Prevent form submission
      const tagInput = event.target.value.trim();
      if (tagInput !== "") {
        addTag(tagInput);
        event.target.value = "";
      }
    }
  });
</script>

<script src="{% static 'post/writePage/responsivePath.js' %}"></script>
<script src="{% static 'post/writePage/modal.js' %}"></script>
<script src="{% static 'post/writePage/path.js' %}"></script>
<!-- 모드변경 -->
<script>
  const main = document.querySelector(".main");
  const modeBtn = document.querySelector(".mode-btn");

  checkmode();

  function checkmode() {
    if (main.classList.contains("column-mode")) {
      modeBtn.innerText = "가로모드로 바꾸기";
      return "col";
    } else {
      modeBtn.innerText = "세로모드로 바꾸기";
      return "row";
    }
  }

  function toggleMode() {
    const allContainer = document.querySelectorAll(".step_container");
    for (let item of allContainer) {
      item.classList.toggle("container_row-mode");
    }
    main.classList.toggle("column-mode");
    checkmode();
  }
</script>
<script>
  let paths = [];
  let steps = [];
  // TODO. COLUM삭제. ORDER변경. 그리고 아이템 ORDER변경.

  const titleInput = document.querySelector("#titleInput");
  const descInput = document.querySelector("#descInput");
  const reviewInput = document.querySelector("#reviewInput");
  const imageInput = document.querySelector("#imageInput");
  const categorySelect = document.querySelector("#categorySelect");

  function showAllItems() {
    console.log(steps);
    console.log(paths);
    console.log(tagList);
  }

  function handleAddPath(prevPathId) {
    let id = uuid.v4();
    addPathNode(prevPathId, id);

    const prevPathItem = paths.find((path) => path.id == prevPathId);
    if (prevPathItem) {
      paths = paths.map((path) =>
        path.order >= prevPathItem.order + 1
          ? {
              ...path,
              order: path.order + 1,
            }
          : path
      );
      paths.push({
        id: id,
        order: prevPathItem.order + 1,
        title: ``,
      });
    } else {
      paths.push({ id: id, order: 1, title: `` });
    }

    updateSelectOptions();
    changeDisplay(id);
  }

  function handleAddStep(targetPathId) {
    let id = uuid.v4();
    addStepNode(targetPathId, id);

    steps.push({
      id,
      pathId: targetPathId,
      order: steps.filter((step) => step.pathId == targetPathId).length + 1,
      isNew: true,
      isEdited: false,
      title: "",
      desc: "",
    });
  }

  function handleDeleteItem(targetStepId) {
    const targetNode = document.querySelector(`.step_${targetStepId}`);
    targetNode.parentNode.removeChild(targetNode);

    const targetStep = steps.find((step) => step.id == targetStepId);

    steps = steps.map((step) => {
      if (step.colId == targetStep.colId && step.order > targetStep.order) {
        step.order -= 1;
        step.isEdited = true;
      }

      return step;
    });
    steps.splice(
      steps.findIndex((step) => step.id == targetStepId),
      1
    );
  }

  function handleDeletePath(targetPathId) {
    const main = document.querySelector(".main");
    const target = main.querySelector(`.path_${targetPathId}`);

    var optionElements = selectElement.getElementsByTagName("option");
    var specificOptionIndex = Array.from(selectElement.options).findIndex(
      function (option) {
        return option.value === targetPathId;
      }
    );
    var targetOption = selectElement.options[specificOptionIndex - 1];

    main.removeChild(target);

    if (main.childElementCount == 0) {
      main.innerHTML = `
      <button type="button" onclick="handleAddPath()" class="btn add_new-btn writePage__btn">
        내 패스 만들기
      </button>
      `;
    }

    paths = paths.filter((path) => path.id == targetPathId);
    steps = steps.filter((step) => step.pathId !== targetPathId);

    updateSelectOptions();

    changeDisplay(targetOption.value);
  }

  function moveItemUp(stepId) {
    const targetStep = steps.find((step) => step.id == stepId);
    const pathId = targetStep.pathId;
    const target = document.querySelector(`.step_${stepId}`);
    const container = document.querySelector(`.path_${pathId} .step_container`);
    const previousNode = target.previousSibling;
    if (!target.previousSibling) return;

    container.removeChild(target);
    container.insertBefore(target, previousNode);

    const movedStep = steps.find(
      (step) => step.pathId == pathId && step.order == targetStep.order - 1
    );

    // targetStep은 order를 -1 . movedStep은 order를 1.
    steps = steps.map((step) => {
      if (step.id == movedStep.id)
        return {
          ...step,
          order: step.order + 1,
        };
      else if (step.id === targetStep.id)
        return {
          ...step,
          order: step.order - 1,
        };
      else return step;
    });
  }

  function moveItemDown(stepId) {
    const targetStep = steps.find((step) => step.id == stepId);
    const pathId = targetStep.pathId;
    const target = document.querySelector(`.step_${stepId}`);
    const container = document.querySelector(`.path_${pathId} .step_container`);
    const nextNode = target.nextSibling;
    if (!nextNode) return;
    const next_nextNode = nextNode.nextSibling;

    container.removeChild(target);

    if (next_nextNode) {
      container.insertBefore(target, next_nextNode);
    } else {
      container.appendChild(target);
    }

    const movedStep = steps.find(
      (step) => step.pathId == pathId && step.order == targetStep.order + 1
    );

    steps = steps.map((step) => {
      if (step.id == movedStep.id)
        return {
          ...step,
          order: step.order - 1,
        };
      else if (step.id === targetStep.id)
        return {
          ...step,
          order: step.order + 1,
        };
      else return step;
    });
  }

  async function handleSubmit(e) {
    e.preventDefault();

    if (!titleInput.value || !descInput.value || !categorySelect.value) {
      //TODO 에러 메시지 띄우기
      console.log("제목, 설명 입력");
      return;
    }

    const formData = new FormData();
    formData.append("thumbnail", imageInput.files[0]);
    formData.append("paths", JSON.stringify(paths));
    formData.append("steps", JSON.stringify(steps));
    formData.append("title", titleInput.value);
    formData.append("desc", descInput.value);
    formData.append("review", reviewInput.value);
    formData.append("tags", JSON.stringify(tagList));
    formData.append("category", categorySelect.value);
    formData.append(
      "mode",
      main.classList.contains("column-mode") ? "col" : "row"
    );

    // const main = document.querySelector(".main");
    const response = await fetch("/post/write", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": csrftoken,
      },
    });

    if (response.status == 200) {
      let response123 = await response.json();
      window.location.href = `/post/${response123.id}`;
    } else {
      location.reload();
    }
  }
</script>

<!-- upload-file 첨부파일명 작성 관련 -->
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script>
  $(document).ready(function () {
    var fileTarget = $(".upload-file .upload-hidden");

    fileTarget.on("change", function () {
      // 값이 변경되면
      if (window.FileReader) {
        // modern browser
        var filename = $(this)[0].files[0].name;
      } else {
        // old IE
        var filename = $(this).val().split("/").pop().split("\\").pop(); // 파일명만 추출
      }

      // 추출한 파일명 삽입
      $(this).siblings(".upload-name").val(filename);
    });
  });
</script>

{% endblock %}

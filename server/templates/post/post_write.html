{% extends 'base.html' %} {% load static %} {% block content %}
<h1>제작 페이지</h1>
<!-- <button onclick="showAllItems()">모든아이템</button> -->
<button onclick="toggleMode()" class="mode-btn">세로모드로</button>
<form onsubmit="handleSubmit(event)">
  <input type="text" placeholder="title" name="title" id="titleInput" />
  <textarea
    type="text"
    placeholder="설명"
    name="dsec"
    id="descInput"
  ></textarea>
  <select id="categorySelect" name="categorySelect">
    {% for cat in categories %}
    <option value="{{cat.name}}">{{cat.name}}</option>
    {% endfor %}
  </select>

  <input
    type="text"
    id="tagInput"
    placeholder="태그를 입력후 enter버튼을 눌러 추가하세요"
  />
  <ul id="tagList"></ul>
  <div class="pathSelect">
    <span>패스 선택</span>
    <select id="pathSelect" class="select"></select>
  </div>
  <div class="main column-mode">
    <button type="button" onclick="handleAddPath()" class="add_new-btn">
      새로운 패스 추가하기
    </button>
  </div>
  <textarea
    type="text"
    name="review"
    placeholder="후기"
    id="reviewInput"
  ></textarea>
  <button type="submit">제출하기</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>

<!-- csrf token -->
<script src="{% static 'post/writePage/csrftoken.js' %}"></script>

<!-- 태그기능 -->
<script>
  // JavaScript code
  const tagList = []; // Array to store tags

  function addTag(tag) {
    if (!tagList.includes(tag)) {
      tagList.push(tag);
      updateTagList();
    }
  }

  function removeTag(tag) {
    const index = tagList.indexOf(tag);
    if (index !== -1) {
      tagList.splice(index, 1);
      updateTagList();
    }
  }

  function updateTagList() {
    const tagListElement = document.getElementById("tagList");
    tagListElement.innerHTML = ""; // Clear the current list

    tagList.forEach((tag) => {
      const li = document.createElement("li");
      const closeButton = document.createElement("span");
      closeButton.innerText = "x";
      closeButton.classList.add("close-button");
      closeButton.onclick = () => removeTag(tag);

      li.innerText = "#" + tag;
      li.appendChild(closeButton);

      tagListElement.appendChild(li);
    });
  }

  document.getElementById("tagInput").addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault(); // Prevent form submission
      const tagInput = event.target.value.trim();
      if (tagInput !== "") {
        addTag(tagInput);
        event.target.value = "";
      }
    }
  });
</script>

<script src="{% static 'post/writePage/responsivePath.js' %}"></script>
<script src="{% static 'post/writePage/modal.js' %}"></script>
<script src="{% static 'post/writePage/path.js' %}"></script>
<!-- 모드변경 -->
<script>
  const main = document.querySelector(".main");
  const modeBtn = document.querySelector(".mode-btn");

  checkmode();
  function checkmode() {
    if (main.classList.contains("column-mode")) {
      modeBtn.innerText = "가로모드로 바꾸기";
      return "col";
    } else {
      modeBtn.innerText = "세로모드로 바꾸기";
      return "row";
    }
  }

  function toggleMode() {
    const allContainer = document.querySelectorAll(".step_container");
    for (let item of allContainer) {
      item.classList.toggle("container_row-mode");
    }
    main.classList.toggle("column-mode");
    checkmode();
  }
</script>
<script>
  let paths = [];
  let steps = [];
  // TODO. COLUM삭제. ORDER변경. 그리고 아이템 ORDER변경.

  const titleInput = document.querySelector("#titleInput");
  const descInput = document.querySelector("#descInput");
  const reviewInput = document.querySelector("#reviewInput");
  const categorySelect = document.querySelector("#categorySelect");

  function showAllItems() {
    console.log(steps);
    console.log(paths);
    console.log(tagList);
  }

  function handleAddPath(prevPathId) {
    let id = uuid.v4();
    addPathNode(prevPathId, id);

    const prevPathItem = paths.find((path) => path.id == prevPathId);
    if (prevPathItem) {
      paths.push({
        id: id,
        order: prevPathItem.order + 1,
        title: `${id.slice(0, 10)}`,
      });
      paths = paths.map((path) =>
        path.order >= prevPathItem.order + 1
          ? { ...path, order: path.order + 1 }
          : path
      );
    } else {
      paths.push({
        id: id,
        order: 1,
        title: `${id.slice(0, 10)}`,
      });
    }

    updateSelectOptions();
    changeDisplay(id);
  }

  function handleAddStep(targetPathId) {
    let id = uuid.v4();
    addStepNode(targetPathId, id);
    steps.push({
      id,
      pathId: targetPathId,
      order: steps.filter((step) => step.pathId == targetPathId).length + 1,
      isNew: true,
      isEdited: false,
      title: "",
      desc: "",
    });
  }

  function handleDeleteItem(targetStepId) {
    const targetNode = document.querySelector(`.step_${targetStepId}`);
    targetNode.parentNode.removeChild(targetNode);

    const targetStep = steps.find((step) => step.id == targetStepId);

    steps = steps.map((step) => {
      if (step.colId == targetStep.colId && step.order > targetStep.order) {
        step.order -= 1;
        step.isEdited = true;
      }

      return step;
    });
    steps.splice(
      steps.findIndex((step) => step.id == targetStepId),
      1
    );
  }

  function handleDeletePath(targetPathId) {
    const main = document.querySelector(".main");
    const target = main.querySelector(`.path_${targetPathId}`);

    var optionElements = selectElement.getElementsByTagName("option");
    var specificOptionIndex = Array.from(selectElement.options).findIndex(
      function (option) {
        return option.value === targetPathId;
      }
    );
    var targetOption = selectElement.options[specificOptionIndex - 1];

    main.removeChild(target);

    if (main.childElementCount == 0) {
      main.innerHTML = `
      <button type="button" onclick="handleAddPath()" class="add_new-btn">
        새로운 패스 추가하기
      </button>
      `;
    }

    paths = paths.filter((path) => path.id == targetPathId);
    steps = steps.filter((step) => step.pathId !== targetPathId);

    updateSelectOptions();

    changeDisplay(targetOption.value);
  }

  function moveItemUp(stepId) {
    const targetStep = steps.find((step) => step.id == stepId);
    const pathId = targetStep.pathId;
    const target = document.querySelector(`.step_${stepId}`);
    const container = document.querySelector(`.path_${pathId} .step_container`);
    const previousNode = target.previousSibling;
    if (!target.previousSibling) return;

    container.removeChild(target);
    container.insertBefore(target, previousNode);

    const movedStep = steps.find(
      (step) => step.pathId == pathId && step.order == targetStep.order - 1
    );

    // targetStep은 order를 -1 . movedStep은 order를 1.
    steps = steps.map((step) => {
      if (step.id == movedStep.id) return { ...step, order: step.order + 1 };
      else if (step.id === targetStep.id)
        return { ...step, order: step.order - 1 };
      else return step;
    });
  }

  function moveItemDown(stepId) {
    const targetStep = steps.find((step) => step.id == stepId);
    const pathId = targetStep.pathId;
    const target = document.querySelector(`.step_${stepId}`);
    const container = document.querySelector(`.path_${pathId} .step_container`);
    const nextNode = target.nextSibling;
    if (!nextNode) return;
    const next_nextNode = nextNode.nextSibling;

    container.removeChild(target);

    if (next_nextNode) {
      container.insertBefore(target, next_nextNode);
    } else {
      container.appendChild(target);
    }

    const movedStep = steps.find(
      (step) => step.pathId == pathId && step.order == targetStep.order + 1
    );

    steps = steps.map((step) => {
      if (step.id == movedStep.id) return { ...step, order: step.order - 1 };
      else if (step.id === targetStep.id)
        return { ...step, order: step.order + 1 };
      else return step;
    });
  }

  async function handleSubmit(e) {
    e.preventDefault();

    if (!titleInput.value || !descInput.value || !categorySelect.value) {
      //TODO 에러 메시지 띄우기
      console.log("제목, 설명 입력");
      return;
    }

    const main = document.querySelector(".main");
    const response = await fetch("/post/write", {
      method: "POST",
      body: JSON.stringify({
        paths: paths,
        steps: steps,
        title: titleInput.value,
        desc: descInput.value,
        review: reviewInput.value,
        tags: tagList,
        category: categorySelect.value,
        mode: main.classList.contains("column-mode") ? "col" : "row",
      }),
      headers: {
        "content-type": "application/json",
        "X-CSRFToken": csrftoken,
      },
    });

    if (response.status == 200) {
      let response123 = await response.json();
      window.location.href = `/post/edit/${response123.id}`;
    }
  }
</script>

{% endblock %}

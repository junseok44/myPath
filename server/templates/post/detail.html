{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="detail-container">
    <div class="intro-container">
        <div class="intro-title">
            <h2>{{post.title}}</h2>
            <a href="/">{{post.user}}</a>
        </div>
        <div class="intro-desc">
            <img src="{{post.thumbnail.url}}">
            <p>{{post.desc}}</p>
        </div>
        
    </div>
    <ul class="main-container {{post.mode}}">
        {% for path in paths %}
        <li class="path path_{{path.id}}">
            <p>{{path.title}}</p>
            <div class="step-container">
                {% for step in path.steps %}
                <section class="step step_{{step.id}}">
                    <div>
                        <p class="title">{{step.title}}</p>
                        <p class="desc">{{step.desc}}</p>
                        <button type="button" onclick="onClickStepDetail('{{step.id}}')">더보기</button>
                    </div>
                    <div class="modal__overlay hidden" id="step-modal-{{step.id}}">
                        <div class="step__modal modal_{{step.id}}">
                          더보기 버튼을 눌렀을때 나오는 모달
                        </div>
                        <div class="step__comment">
                            {% for step_comment in step_comments %}
                            {% endfor %}
                            <input type="text" class="new-comment" placeholder="댓글을 입력하세요">
                            <input type="submit" value="submit">
                          </div>
                    </div>
                </section>
                {% endfor %}
            </div>
        </li>    
        {% endfor %}
    </ul>
    <div class="review-container">
        <div class="review-content">{{post.review}}</div>
        <div class="comment-container">
            {% for post_comment in post_comments%}
            <p>{{post_comment.writer}}</p>
            <p>{{post_comment.text}}</p>
            {% endfor %}
            <form action="{%url 'post_comment_create' post.id%}" method="POST">
                {%csrf_token%}
                <input type="text" name="comment" placeholder="댓글을 입력하세요">
                <input type="submit" value="submit">
            </form>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
<script>

    var clicked=0;
    const requestStepDetail=new XMLHttpRequest();
    onClickStepDetail=(step_id)=>{
        
        var element= document.getElementById(`step-modal-${step_id}`);
        element.classList.toggle("hidden");
        
        //url은 post/step
        const url='step';
        requestStepDetail.open("POST",url,true);
        requestStepDetail.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        var data =JSON.stringify({step_id: step_id});
        requestStepDetail.send(data);
    };
    requestStepDetail.onreadystatechange=()=>{
        if(requestStepDetail.readyState===XMLHttpRequest.DONE){
            if(requestStepDetail.status<400){
                    
                if (clicked!=1){
                    // element.innerHTML+= `<p>text</p>`;
                    clicked=1;
                    const {step,step_comments}=JSON.parse(requestStepDetail.response|escapejs);
                    const parent=document.querySelector(`.modal_${step.id}`);
                    parent.innerHTML += 
                    `<div class="step-${step.id}">
                        <h2>${step.title}<h2>
                        <p>${step.desc}</p>
                    </div>`;
                }
            }
        }
    };

    const requestCommentCreate=new XMLHttpRequest();
    const onClickStepComment=(id)=>{
        const url='step/comment_create/'; //    post/step/comment_create
        const text=document.querySelector(`.new-comment`).value;
        requestCommentCreate.open("POST",url,true);
        requestCommentCreate.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        requestCommentCreate.send(JSON.stringify({id:id,text:text}))

    };

    requestCommentCreate.onreadystatechange=()=>{
        if(requestCommentCreate.readyState===XMLHttpRequest.DONE){
            if(requestCommentCreate.status<400){
                const{id,comment_id,content}=JSON.parse(requestCommentCreate.response);
                const parent=document.querySelector(`.step__comment`);
                parent.innerHTML += 
                `<div class="step-comment-${comment_id}">
                    <p>${content}</p>
                </div>`;
            }
        }
    };
    

</script>
{% endblock %}
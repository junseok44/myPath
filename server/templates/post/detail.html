{% extends 'base.html' %} {% load static %} {% block content %}
<div class="detail-container">
  <div class="intro-container">
    <div class="intro-title">
      <h2>{{post.title}}</h2>
      <a href="/">{{post.user}}</a>
    </div>
    <div class="intro-desc">
      {% if post.thumbnail %}
      <img src="{{post.thumbnail.url}}" />
      {% else %}
      <img src="{% static 'noimage.jpg' %}" />
      {% endif %}
      <p>
        좋아요 수 : <span class="post-likes">{{post.like_table.count}}</span>
      </p>
      <p>
        북마크 수 :
        <span class="post-bookmarks">{{post.bookmark_table.count}}</span>
      </p>
      <p>{{post.desc}}</p>
      {% if user.is_authenticated %}
      <p>{{user.username}}님</p>
      <button class="like-btn" onclick="likeToggle('{{post.id}}')">
        {% if post.isLiked %} 좋아요취소 {% else %} 좋아요하기 {% endif %}
      </button>
      <button class="bookmark-btn" onclick="bookMarkToggle('{{post.id}}')">
        {% if post.isBookMarked %} 북마크취소 {% else %} 북마크하기 {% endif %}
      </button>
      {% endif %}
    </div>
  </div>
  <ul class="main-container {{post.mode}}">
    {% for path in paths %}
    <li class="path path_{{path.id}}">
      <p>{{path.title}}</p>
      <div class="step-container">
        {% for step in path.steps %}
        <section class="step step_{{step.id}}">
          <div>
            <p class="title">{{step.title}}</p>
            <p class="desc">{{step.desc}}</p>
            <button type="button" onclick="onClickStepDetail('{{step.id}}')">
              더보기
            </button>
          </div>
          <div class="modal__overlay">
            <div class="step__modal modal_{{step.id}} hidden" id="step-modal-{{step.id}}">
              <!-- 더보기 버튼을 눌렀을때 나오는 모달 -->
              <h3>{{step.title}}</h3>
              {% if step.Image %}
              <img src="{{step.Image.url}}" />
              {% else %} {% endif %}
              <p>{{step.desc}}</p>
              <div class="step__comment">
                <input type="text" class="new-comment" placeholder="댓글을 입력하세요"/>
                <button class="comment-create" onclick="onClickStepComment('{{step.id}}')">댓글 쓰기</button>
              </div>
            </div>
          </div>
        </section>
        {% endfor %}
      </div>
    </li>
    {% endfor %}
    </ul>
    <div class="review-container">
        <div class="review-content">{{post.review}}</div>
        <div class="comment-container">
            {% for post_comment in post_comments%}
            <p>{{post_comment.writer}}</p>
            <p>{{post_comment.text}}</p>
            {% endfor %}
            <form action="{%url 'post_comment_create' post.id%}" method="POST">
                {%csrf_token%}
                <input type="text" name="comment" placeholder="댓글을 입력하세요">
                <input type="submit" value="submit">
            </form>
        </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
<script>

    var clicked=0;
    const requestStepDetail=new XMLHttpRequest();
    onClickStepDetail=(step_id)=>{
        
        var element= document.getElementById(`step-modal-${step_id}`);
        element.classList.toggle("hidden");
        
        //url은 post/step
        const url='step';
        requestStepDetail.open("POST",url,true);
        requestStepDetail.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        var data =JSON.stringify({step_id: step_id});
        requestStepDetail.send(data);
    };
    requestStepDetail.onreadystatechange=()=>{
        if(requestStepDetail.readyState===XMLHttpRequest.DONE){
            if(requestStepDetail.status<400){
                    
                if (clicked!=1){
                    // element.innerHTML+= `<p>text</p>`;
                    clicked=1;
                    const {step,step_comments}=JSON.parse(requestStepDetail.response|escapejs);
                    const parent=document.querySelector(`.modal_${step.id}`);
                    parent.innerHTML += 
                    `<div class="step-${step.id}">
                        <h2>${step.title}<h2>
                        <p>${step.desc}</p>
                    </div>`;
                }
            }
        }
    };

    const requestCommentCreate=new XMLHttpRequest();
    const onClickStepComment=(id)=>{
        const url='step/comment_create/'; //    post/step/comment_create
        const text=document.querySelector(`.new-comment`).value;
        requestCommentCreate.open("POST",url,true);
        requestCommentCreate.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        requestCommentCreate.send(JSON.stringify({id:id,text:text}))

    };

    requestCommentCreate.onreadystatechange=()=>{
        if(requestCommentCreate.readyState===XMLHttpRequest.DONE){
            if(requestCommentCreate.status<400){
                const{id,comment_id,content}=JSON.parse(requestCommentCreate.response);
                const parent=document.querySelector(`.step__comment`);
                parent.innerHTML += 
                `<div class="step-comment-${comment_id}">
                    <p>${content}</p>
                </div>`;
            }
        }
    };
    


// <!-- csrf token. fetch 요청할때 header에 넣어주면 @exempt 안써도 되요. 밑에 사용례 참고 -->
// <script>
//   function getCookie(name) {
//     const value = `; ${document.cookie}`;
//     const parts = value.split(`; ${name}=`);
//     if (parts.length === 2) return parts.pop().split(";").shift();
//   }
// </script>

<!-- 북마크, 좋아요 관련 스크립트 -->
<script>
  const bookmarkBtn = document.querySelector(".bookmark-btn");
  const likeBtn = document.querySelector(".like-btn");

  const bookmarkCount = document.querySelector(".post-bookmarks");
  const likeCount = document.querySelector(".post-likes");
  async function bookMarkToggle(postId) {
    const response = await fetch("/api/toggleBookMark/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCookie("csrftoken"), // Replace with your method of getting CSRF token
      },
      body: JSON.stringify({
        postId: postId,
      }),
    });

    if (response.ok) {
      const data = await response.json();

      if (data.isBookMarked) {
        bookmarkBtn.innerHTML = "북마크취소";
      } else {
        bookmarkBtn.innerHTML = "북마크하기";
      }

      bookmarkCount.innerHTML = data["bookMark_count"];
    } else {
      console.error("Error toggling bookmark");
    }
  }

  async function likeToggle(postId) {
    const response = await fetch("/api/toggleLike/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCookie("csrftoken"), // Replace with your method of getting CSRF token
      },
      body: JSON.stringify({
        postId: postId,
      }),
    });

    if (response.ok) {
      const data = await response.json();
      if (data.isLiked) {
        likeBtn.innerHTML = "좋아요취소";
      } else {
        likeBtn.innerHTML = "좋아요하기";
      }
      likeCount.innerHTML = data["like_count"];
    } else {
      console.error("Error toggling like");
    }
  }
</script>

{% endblock %}

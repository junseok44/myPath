{% extends 'base.html' %} {% load static %} {% block content %}

<h1>edit</h1>
<button onclick="showAllItems()">모든아이템</button>

<form class="edit__form" onsubmit="handleSubmit(event)">
  <span>제목</span>

  <input
    type="text"
    placeholder="title"
    name="title"
    id="titleInput"
    value="{{post.title}}"
  />
  <span>내용</span>
  <textarea type="text" placeholder="설명" name="dsec" id="descInput">
{{post.desc}}</textarea
  >
  <span>카테고리 선택</span>
  <select id="categorySelect" name="categorySelect">
    {% for cat in categories %}
    <option value="{{cat.name}}" {% if cat.name == currentCategory %} selected {% endif %}>{{cat.name}}</option>
    {% endfor %}
  </select>
  <p>모든태그</p>
  <ul id="tagList">
    {% for tagtable in post.tag_table.all %}
    <li>{{tagtable.tag.name}}</li>
    {% endfor %}
  </ul>
  <hr />
  <select id="pathSelect" class="select"></select>
  <ul class="main column-mode">
    {% if paths|length == 0 %}
    <button type="button" onclick="handleAddPath()" class="add_new-btn">
      옆에 새로운 패스 추가하기
    </button>
    {% endif %}
    {% for path in paths %}
    <li class="path path_{{path.id}}">
      <input placeholder="패스 이름 입력..." type="text" value="{{path.title}}" class="path_title" onchange="handleChangePathTitle(event,'${id}')">
      <button type="button" onclick="handleAddPath('{{path.id}}')">
        옆에 패스 추가하기
      </button>
      <button type="button" onclick="handleDeletePath('{{path.id}}')">
        이 패스 삭제하기
      </button>
      <div class="step_container">
        {% for step in path.steps %}
        <section class="step step_{{step.id}}">
          <div>
            <p class="title">{{step.title}}</p>
            <p class="desc">{{step.desc}}</p>
            <button type="button" onclick="moveItemUp('{{step.id}}')">
              위로 올리기
            </button>
            <button type="button" onclick="moveItemDown('{{step.id}}')">밑으로 내리기</button>
            <button type="button" onclick="handleDeleteItem('{{step.id}}')">
              삭제하기
            </button>
            <button
              class="edit-btn"
              type="button"
              onclick="handleToggleModal('{{step.id}}')"
            >
              편집하기
            </button>
          </div>
          <div class="modal__overlay hidden">
            <div class="step__edit-modal modal_{{step.id}} hidden">
              <input type="text" class="title" />
              <textarea class="desc"></textarea>
              <div>
                <button type="button" onClick="handleToggleModal('{{step.id}}')">
                  취소
                </button>
                <button type="button" onclick="handleSaveValue('{{step.id}}')">
                  변경
                </button>
              </div>
            </div>
          </div>

        
        </section>

        {% endfor %}
      </div>
      <button
        type="button"
        onclick="handleAddStep('{{path.id}}')"
        class="item_add-btn"
      >
        밑에 스텝 추가하기
      </button>
    </li>
    {% endfor %}
  </ul>
  <hr />
  <span>후기</span>

  <input
    type="text"
    name="review"
    placeholder="후기"
    id="reviewInput"
    value="{{post.review}}"
  />

  <button type="button" onclick="handleFormCancel()">취소하기</button>
  <button type="submit">변경하기</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>

<!-- csrf token -->
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");
</script>

<!-- 반응형 path 디자인 -->
<script>
const listElement = document.querySelector('.main');
const selectElement = document.getElementById('pathSelect');

function updateSelectOptions() {
  selectElement.innerHTML = '';
  const listItems = listElement.querySelectorAll('.path');
  for (const listItem of listItems) {

    const pathTitle = listItem.querySelector(".path_title").value
    const option = document.createElement('option');
    const classNames = listItem.className.split(' ');
    let id = null;
    for (const className of classNames) {
      if (className.startsWith('path_')) {
        id = className.slice(5); // Remove "step_" from the class name to get the "id"
        option.value = id
      }
    }
    option.textContent = pathTitle
    selectElement.appendChild(option);
  }
}

// Show the selected list item when an option is selected in the dropdown
selectElement.addEventListener('change', () => {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  const selectedValue = selectedOption.value;
  const listItems = listElement.querySelectorAll('.path');

  // Hide all list items
  listItems.forEach(item => item.style.display = 'none');

  // Show the selected list item
  const selectedItem = Array.from(listItems).find(item => item.classList.contains(`path_${selectedValue}`));
  if (selectedItem) {
    selectedItem.style.display = 'block';
  }
});

if(window.innerWidth <= 600) {
  const listItems = listElement.querySelectorAll('.path');
  listItems.forEach(item => item.style.display = 'none')

  listItems[0].style.display = "block"
  updateSelectOptions()
}

// 개발용 이벤트 리스너.
window.addEventListener('resize', () => {
  if (window.innerWidth <= 600) {
    const listItems = listElement.querySelectorAll('.path');
    listItems.forEach(item => item.style.display = 'none')
  listItems[0].style.display = "block"
    updateSelectOptions();
  } else {
    const listItems = listElement.querySelectorAll('.path');
    listItems.forEach(item => item.style.display = 'block')
  }
});

</script>

<!-- 메인 핸들러 -->
<script>
  const postData = JSON.parse("{{ jsonPost|escapejs }}");
  const pathData = JSON.parse("{{ jsonPaths|escapejs }}");
  const stepData = JSON.parse("{{ jsonSteps|escapejs }}");

  let paths = [];
  let steps = [];
  let deletedIds = [];
  let deletedPaths = [];

  const main = document.querySelector(".main");
  const descInput = document.querySelector("#descInput");
  const categorySelect = document.querySelector("#categorySelect");

  for (let path of pathData) {
    let newPath = {
      ...path.fields,
      id: path.pk,
      isNew: false,
      isEdited: true,
    };
    paths.push(newPath);
  }

  for (let instance of stepData) {
    let item = {
      ...instance.fields,
      id: instance.pk,
      isNew: false,
      isEdited: false,
    };

    item["pathId"] = item["path"];
    delete item["path"];
    steps.push(item);
  }

  function showAllItems() {
    console.log(steps);
    console.log(paths);
  }

  function handleToggleModal(id) {
    const modal = document.querySelector(`.modal_${id}`);
    modal.classList.toggle("hidden");
    modal.parentElement.classList.toggle("hidden")
    // 토글시 다른 아이템들은 다 숨겨지도록 해야함.

    titleVal = descVal = document.querySelector(`.step_${id} .title`).innerText;
    descVal = descVal = document.querySelector(`.step_${id} .desc`).innerText;

    const titleForm = modal.querySelector(".title");
    const descForm = modal.querySelector(".desc");

    titleForm.value = titleVal;
    descForm.value = descVal;
  }

  function handleSaveValue(id) {
    const modal = document.querySelector(`.modal_${id}`);
    const titleForm = modal.querySelector(".title");
    const descForm = modal.querySelector(".desc");

    const titleNode = document.querySelector(`.step_${id} .title`);
    const descNode = document.querySelector(`.step_${id} .desc`);

    titleNode.innerText = titleForm.value;
    descNode.innerText = descForm.value;
    modal.classList.toggle("hidden");
    modal.parentElement.classList.toggle("hidden")


    step = steps.find((step) => step.id == id);
    step.title = titleForm.value;
    step.desc = descForm.value;
    step.isEdited = true;
  }

  function handleChangePathTitle(e,pathId) {
    paths = paths.map(path => path.id == pathId ? {...path, title : e.target.value, isEdited: true} : path )
  }

  function handleAddPath(prevPathId) {
    const main = document.querySelector(".main");
    const NewBtn = document.querySelector(".add_new-btn");
    if (NewBtn) {
      NewBtn.parentNode.removeChild(NewBtn);
    }
    let isColumnMode = main.classList.contains("column-mode");
    let id = uuid.v4();

    li = document.createElement("li");
    li.classList.add(`path`);
    li.classList.add(`path_${id}`);
    // li.innerText = `${id.slice(0, 10)}`;
    li.innerHTML += `
        <input placeholder="패스 이름 입력..." type="text" class="path_title" onchange="handleChangePathTitle(event,'${id}')">
        <button type="button" onclick="handleAddPath('${id}')">옆에 패스 추가하기</button>
        <button type="button" onclick="handleDeletePath('${id}')">이 패스 삭제하기</button>

        <div class="step_container${isColumnMode ? "" : "container_row-mode"}">
                </div>
        <button type="button" onclick="handleAddStep('${id}')" class="item_add-btn">
              밑에 아이템 추가하기
            </button>
        `;
    if(prevPathId) {
      const prevPath = document.querySelector(`.path_${prevPathId}`);
    if (prevPath.nextSibling) {
      main.insertBefore(li, prevPath.nextSibling);
    } else {
      main.append(li);
    }
    } else {
      main.append(li)
    }
 
  
    const prevPathItem = paths.find((path) => path.id == prevPathId);

    if (prevPathItem) {
 

  paths = paths.map((path) =>
    path.order >= prevPathItem.order + 1
      ? { ...path, order: path.order + 1 , isNew: false, isEdited: true}
      : path
  );

  paths.push({
    id: id,
    order: prevPathItem.order + 1,
    title: `${id.slice(0, 10)}`,
    isNew: true,
      isEdited: false,
  });
} else {
  paths.push({
    id: id,
    order: 1,
    title: `${id.slice(0, 10)}`,
    isNew: true,
    isEdited: false,
  });
}

    updateSelectOptions()
  }

  function handleAddStep(targetPathId) {
    let id = uuid.v4();
    const stepContainer = document.querySelector(
      `.path_${targetPathId} .step_container`
    );
    const section = document.createElement("section");
    section.classList.add(`step`);
    section.classList.add(`step_${id}`);
    section.innerHTML = `
              <div>
                <p class="title"></p>
                <p class="desc"></p>
                <button type="button" onclick="moveItemUp('${id}')">위로 올리기</button>
                <button type="button" onclick="moveItemDown('${id}')">밑으로 내리기</button>
                <button type="button" onclick="handleDeleteItem('${id}')">삭제하기</button>
                <button
                  class="edit-btn"
                  type="button"
                  onclick="handleToggleModal('${id}')"
                >
                  편집하기
                </button>
              </div>
              <div class="modal__overlay hidden">
              <div class="step__edit-modal modal_${id} hidden">
                <input type="text" class="title" />
                <textarea class="desc"></textarea>
                <div>
                  <button type="button" onClick="handleToggleModal('${id}')">취소</button>
                  <button type="button" onclick="handleSaveValue('${id}')">변경</button>
                </div>
              </div>
              </div>
        `;
    stepContainer.appendChild(section);

    steps.push({
      id,
      pathId: targetPathId,
      order: steps.filter((step) => step.pathId == targetPathId).length + 1,
      isNew: true,
      isEdited: false,
      title: "",
      desc: "",
    });
  }

  function handleDeleteItem(stepId) {
    const step = document.querySelector(`.step_${stepId}`);
    step.parentNode.removeChild(step);

    steps = steps.filter((step) => step.id !== stepId);
    deletedIds.push(stepId);
  }

  function moveItemUp(stepId) {
    const targetStep = steps.find((step) => step.id == stepId);
    const pathId = targetStep.pathId;
    const target = document.querySelector(`.step_${stepId}`);
    const container = document.querySelector(`.path_${pathId} .step_container`);
    const previousNode = target.previousElementSibling;
    if (!previousNode) return;

    container.removeChild(target);
    container.insertBefore(target, previousNode);
    
    const movedStep = steps.find(
      (step) => step.pathId == pathId && step.order == targetStep.order - 1
    );
    // targetStep은 order를 -1 . movedStep은 order를 1.
    steps = steps.map((step) => {
      if (step.id == movedStep.id) return { ...step, order: step.order + 1, isEdited: true };
      else if (step.id === targetStep.id)
        return { ...step, order: step.order - 1, isEdited: true };
      else return step;
    });
  }

  function moveItemDown(stepId) {
    const targetStep = steps.find((step) => step.id == stepId);
    const pathId = targetStep.pathId;
    const target = document.querySelector(`.step_${stepId}`);
    const container = document.querySelector(`.path_${pathId} .step_container`);
    const nextNode = target.nextElementSibling;

    if (!nextNode) return;
    const next_nextNode = nextNode.nextElementSibling;
    container.removeChild(target);

    if (next_nextNode) {
      container.insertBefore(target, next_nextNode);

    } else {
      container.appendChild(target);
      console.log("append last");
    }

    const movedStep = steps.find(
      (step) => step.pathId == pathId && step.order == targetStep.order + 1
    );

    steps = steps.map((step) => {
      if (step.id == movedStep.id) return { ...step, order: step.order - 1, isEdited: true };
      else if (step.id === targetStep.id)
        return { ...step, order: step.order + 1, isEdited: true };
      else return step;
    });
  }


  function handleDeletePath(targetPathId) {
    const main = document.querySelector(".main");
    const target = main.querySelector(`.path_${targetPathId}`);
    main.removeChild(target);

    if (main.childElementCount == 0) {
      main.innerHTML = `
      <button type="button" onclick="handleAddPath()" class="add_new-btn">
      옆에 새로운 패스 추가하기
      </button>
      `;
    }
    deletedPaths.push(targetPathId);
    paths = paths.filter((path) => path.id == targetPathId);
    steps = steps.filter((step) => step.pathId !== targetPathId);
  }

  async function handleSubmit(e) {
    e.preventDefault();

    if(!titleInput.value || !descInput.value ) return;

    const response = await fetch(`/post/edit/${postData[0].pk}`, {
      method: "POST",
      body: JSON.stringify({
        paths: paths,
        steps: steps,
        deletedPaths: deletedPaths,
        deletedIds: deletedIds,
        title: titleInput.value,
        desc: descInput.value,
        review: reviewInput.value,
        category: categorySelect.value,
        mode: "col",
      }),
      headers: {
        "content-type": "application/json",
        "X-CSRFToken": csrftoken,
      },
    });

    console.log(await response.json());
    // window.location.href = "/";
  }
</script>
{% endblock %}
